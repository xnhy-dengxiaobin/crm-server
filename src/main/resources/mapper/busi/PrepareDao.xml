<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="io.renren.modules.busi.dao.PrepareDao">

    <!-- 可根据自己的需求，是否要使用 -->
    <resultMap type="io.renren.modules.busi.entity.PrepareEntity" id="prepareMap">
        <result property="id" column="id"/>
        <result property="name" column="name"/>
        <result property="sex" column="sex"/>
        <result property="mobile" column="mobile"/>
        <result property="mobile1" column="mobile1"/>
        <result property="mobile2" column="mobile2"/>
        <result property="mobile3" column="mobile3"/>
        <result property="projectId" column="project_id"/>
        <result property="projectName" column="project_name"/>
        <result property="userId" column="user_id"/>
        <result property="customerId" column="customer_id"/>
        <result property="status" column="status"/>
        <result property="statusUpdatedTime" column="status_updated_time"/>
        <result property="busiStatus" column="busi_status"/>
        <result property="busiStatusUpdatedTime" column="busi_status_updated_time"/>
        <result property="createdTime" column="created_time"/>
        <result property="updatedTime" column="updated_time"/>
    </resultMap>

    <select id="slct" resultMap="prepareMap">
        select t1.*,t2.busi_status,t2.busi_status_updated_time,t3.name as project_name
        from busi_prepare t1
        left join busi_customer t2 on t1.customer_id = t2.id
        inner join busi_project t3 on t1.project_id = t3.id
        where t1.user_id=#{userId}
        <if test=" id != null and id > 0 ">
            and t1.id = #{id}
        </if>
        <if test="name!=null and name !='' ">
            and t1.name like '%${name}%'
        </if>
        <if test="mobile!=null and mobile !='' ">
            and (t1.mobile like '%${mobile}'
            or t1.mobile1 like '%${mobile}'
            or t1.mobile2 like '%${mobile}'
            or t1.mobile3 like '%${mobile}')
        </if>
        <if test="projectId!=null and projectId !='' ">
            and t1.project_id = #{projectId}
        </if>
        <if test="customerStatus!=null and customerStatus !='' ">
            and t2.busi_status like '%${customerStatus}%'
        </if>
        <if test="prepareStatus!=null and prepareStatus !='' ">
            and t1.status = #{prepareStatus}
        </if>
        <if test="start!=null">
            and t1.created_time >= #{start}
        </if>
        <if test="end!=null">
            <![CDATA[
                and t1.created_time <= #{end}
                ]]>
        </if>
        <if test="sort=='0'">
            order by t2.busi_status_updated_time desc, t1.status_updated_time desc
        </if>
        <if test="sort=='1'">
            order by t2.busi_status_updated_time asc, t1.status_updated_time asc
        </if>
        <if test="sort=='2'">
            order by t2.updated_time desc
        </if>
        <if test="sort=='3'">
            order by t2.updated_time asc
        </if>

        limit #{offset},#{limit}
    </select>
    <select id="cnt" resultType="long">
        select count(*)
        from busi_prepare t1
        left join busi_customer t2 on t1.customer_id = t2.id
        inner join busi_project t3 on t1.project_id = t3.id
        where t1.user_id=#{userId}
        <if test=" id != null and id > 0 ">
            and t1.id = #{id}
        </if>
        <if test="name!=null and name !='' ">
            and t1.name like '%${name}%'
        </if>
        <if test="mobile!=null and mobile !='' ">
            and (t1.mobile like '%${mobile}'
            or t1.mobile1 like '%${mobile}'
            or t1.mobile2 like '%${mobile}'
            or t1.mobile3 like '%${mobile}')
        </if>
        <if test="projectId!=null and projectId !='' ">
            and t1.project_id = #{projectId}
        </if>
        <if test="customerStatus!=null and customerStatus !='' ">
            and t2.busi_status like '%${customerStatus}%'
        </if>
        <if test="prepareStatus!=null and prepareStatus !='' ">
            and t1.status = #{prepareStatus}
        </if>
        <if test="start!=null">
            and t1.created_time >= #{start}
        </if>
        <if test="end!=null">
            <![CDATA[
                and t1.created_time <= #{end}
                ]]>
        </if>
    </select>
</mapper>